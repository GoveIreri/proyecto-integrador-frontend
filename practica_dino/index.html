<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dino Run</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .game-header {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .game-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .hud {
            display: flex;
            gap: 2rem;
            font-weight: bold;
        }

        .game-container {
            margin: 2rem 0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        #gameCanvas {
            background: linear-gradient(to bottom, #87CEEB 0%, #98FB98 70%, #228B22 100%);
            display: block;
        }

        .controls {
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .controls p {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            color: #333;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-content h2 {
            color: #e74c3c;
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .score-display {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #4a90e2;
        }

        .score-display p {
            margin: 0.5rem 0;
            font-weight: bold;
        }

        .name-input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 1rem;
        }

        .name-input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4a90e2;
            color: white;
        }

        .btn-primary:hover {
            background: #357abd;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }

        .leaderboard {
            margin-top: 2rem;
            width: 100%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
        }

        .leaderboard h3 {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .leaderboard-list {
            list-style: none;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            margin: 0.5rem 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .rank {
            font-weight: bold;
            width: 30px;
            height: 30px;
            background: #4a90e2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .rank.gold { background: #f39c12; }
        .rank.silver { background: #95a5a6; }
        .rank.bronze { background: #d35400; }

        @media (max-width: 768px) {
            .game-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .hud {
                gap: 1rem;
                font-size: 0.9rem;
            }

            #gameCanvas {
                width: 95vw !important;
                height: auto !important;
            }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <a href="../index.html" class="back-button">‚Üê Volver al Inicio</a>
        <h1 class="game-title">ü¶ñ RunnerJS</h1>
        <div class="hud">
            <span>Puntuaci√≥n: <span id="score">0</span></span>
            <span>Nivel: <span id="level">1</span></span>
            <span>R√©cord: <span id="highScore">0</span></span>
        </div>
    </div>

    <div class="game-container">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
    </div>

    <div class="controls">
        <p>üéÆ <strong>Controles:</strong></p>
        <p>Presiona <strong>ESPACIO</strong> o haz <strong>CLIC</strong> para saltar</p>
        <p>Presiona <strong>R</strong> para reiniciar cuando pierdas</p>
    </div>

    <div class="leaderboard">
        <h3>üèÜ Mejores Puntuaciones</h3>
        <ul id="leaderboardList" class="leaderboard-list">
            <li class="leaderboard-item">
                <div class="player-info">
                    <span class="rank">-</span>
                    <span>Cargando puntuaciones...</span>
                </div>
                <span>-</span>
            </li>
        </ul>
    </div>

    <!-- Modal Game Over -->
    <div id="gameOverModal" class="game-over-modal">
        <div class="modal-content">
            <h2>¬°Fin del Juego!</h2>
            <div class="score-display">
                <p>Puntuaci√≥n Final: <span id="finalScore">0</span></p>
                <p>Nivel Alcanzado: <span id="finalLevel">1</span></p>
                <p id="newRecord" style="color: #27ae60; display: none;">üéâ ¬°Nuevo R√©cord!</p>
            </div>
            <input type="text" id="playerName" class="name-input" placeholder="Ingresa tu nombre..." maxlength="20">
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveScore()">üíæ Guardar</button>
                <button class="btn btn-secondary" onclick="restartGame()">üîÑ Reintentar</button>
            </div>
        </div>
    </div>

    <script>
        // Variables del juego
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Estado del juego
        let gameState = {
            running: false,
            score: 0,
            level: 1,
            speed: 3,
            highScore: localStorage.getItem('runnerHighScore') || 0
        };

        // Jugador
        const player = {
            x: 100,
            y: 300,
            width: 40,
            height: 40,
            velocityY: 0,
            jumping: false,
            grounded: true
        };

        // Obst√°culos
        let obstacles = [];
        let obstacleTimer = 0;
        const obstacleInterval = 120; // frames entre obst√°culos

        // Nubes (decoraci√≥n)
        let clouds = [];

        // Part√≠culas
        let particles = [];

        // Actualizar HUD
        function updateHUD() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('highScore').textContent = gameState.highScore;
        }

        // Crear nube
        function createCloud() {
            return {
                x: canvas.width + Math.random() * 200,
                y: 50 + Math.random() * 100,
                width: 60 + Math.random() * 40,
                height: 30 + Math.random() * 20,
                speed: 0.5 + Math.random() * 0.5
            };
        }

        // Crear obst√°culo
        function createObstacle() {
            const types = ['cactus', 'rock', 'bird'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let obstacle = {
                x: canvas.width,
                width: 30,
                height: 30,
                type: type
            };

            if (type === 'bird') {
                obstacle.y = 250 + Math.random() * 50;
                obstacle.height = 25;
            } else {
                obstacle.y = 310;
                obstacle.height = 40;
                if (type === 'rock') {
                    obstacle.width = 25;
                    obstacle.height = 35;
                }
            }

            return obstacle;
        }

        // Crear part√≠cula
        function createParticle(x, y) {
            return {
                x: x,
                y: y,
                velocityX: -2 - Math.random() * 3,
                velocityY: -1 - Math.random() * 2,
                life: 30,
                maxLife: 30
            };
        }

        // Dibujar jugador (dinosaurio)
        function drawPlayer() {
            ctx.fillStyle = '#2ecc71';
            ctx.fillRect(player.x, player.y, player.width, player.height);
            
            // Detalles del dinosaurio
            ctx.fillStyle = '#27ae60';
            // Cabeza
            ctx.fillRect(player.x + 25, player.y - 15, 20, 20);
            // Patas
            if (Math.floor(gameState.score / 10) % 2 === 0) {
                ctx.fillRect(player.x + 5, player.y + 40, 8, 15);
                ctx.fillRect(player.x + 20, player.y + 40, 8, 15);
            } else {
                ctx.fillRect(player.x + 10, player.y + 40, 8, 15);
                ctx.fillRect(player.x + 25, player.y + 40, 8, 15);
            }
            
            // Ojo
            ctx.fillStyle = 'white';
            ctx.fillRect(player.x + 28, player.y - 12, 6, 6);
            ctx.fillStyle = 'black';
            ctx.fillRect(player.x + 30, player.y - 10, 2, 2);
        }

        // Dibujar obst√°culo
        function drawObstacle(obstacle) {
            if (obstacle.type === 'cactus') {
                ctx.fillStyle = '#2d5a0b';
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                ctx.fillRect(obstacle.x + 10, obstacle.y - 10, 10, 15);
                ctx.fillRect(obstacle.x - 5, obstacle.y + 10, 10, 15);
            } else if (obstacle.type === 'rock') {
                ctx.fillStyle = '#7f8c8d';
                ctx.beginPath();
                ctx.arc(obstacle.x + obstacle.width/2, obstacle.y + obstacle.height/2, obstacle.width/2, 0, Math.PI * 2);
                ctx.fill();
            } else if (obstacle.type === 'bird') {
                ctx.fillStyle = '#8b4513';
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                // Alas
                ctx.fillStyle = '#654321';
                if (Math.floor(gameState.score / 5) % 2 === 0) {
                    ctx.fillRect(obstacle.x - 5, obstacle.y + 5, 15, 8);
                    ctx.fillRect(obstacle.x + 20, obstacle.y + 5, 15, 8);
                } else {
                    ctx.fillRect(obstacle.x - 8, obstacle.y + 2, 18, 10);
                    ctx.fillRect(obstacle.x + 20, obstacle.y + 2, 18, 10);
                }
            }
        }

        // Dibujar nube
        function drawCloud(cloud) {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.beginPath();
            ctx.arc(cloud.x, cloud.y, cloud.width * 0.3, 0, Math.PI * 2);
            ctx.arc(cloud.x + cloud.width * 0.3, cloud.y, cloud.width * 0.4, 0, Math.PI * 2);
            ctx.arc(cloud.x + cloud.width * 0.6, cloud.y, cloud.width * 0.3, 0, Math.PI * 2);
            ctx.fill();
        }

        // Dibujar part√≠cula
        function drawParticle(particle) {
            const alpha = particle.life / particle.maxLife;
            ctx.fillStyle = `rgba(231, 76, 60, ${alpha})`;
            ctx.fillRect(particle.x, particle.y, 3, 3);
        }

        // Dibujar suelo
        function drawGround() {
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(0, 350, canvas.width, 50);
            
            // L√≠nea del suelo
            ctx.strokeStyle = '#654321';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, 350);
            ctx.lineTo(canvas.width, 350);
            ctx.stroke();
        }

        // Saltar
        function jump() {
            if (player.grounded) {
                player.velocityY = -12;
                player.jumping = true;
                player.grounded = false;
            }
        }

        // Detectar colisi√≥n
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // Actualizar juego
        function update() {
            if (!gameState.running) return;

            // Actualizar jugador
            player.velocityY += 0.8; // gravedad
            player.y += player.velocityY;

            // Verificar si est√° en el suelo
            if (player.y >= 300) {
                player.y = 300;
                player.velocityY = 0;
                player.jumping = false;
                player.grounded = true;
            }

            // Crear obst√°culos
            obstacleTimer++;
            if (obstacleTimer >= obstacleInterval - (gameState.level * 5)) {
                obstacles.push(createObstacle());
                obstacleTimer = 0;
            }

            // Actualizar obst√°culos
            for (let i = obstacles.length - 1; i >= 0; i--) {
                obstacles[i].x -= gameState.speed;

                // Eliminar obst√°culos fuera de pantalla
                if (obstacles[i].x + obstacles[i].width < 0) {
                    obstacles.splice(i, 1);
                    gameState.score += 10;
                    continue;
                }

                // Verificar colisi√≥n
                if (checkCollision(player, obstacles[i])) {
                    gameOver();
                    return;
                }
            }

            // Crear nubes ocasionalmente
            if (Math.random() < 0.005) {
                clouds.push(createCloud());
            }

            // Actualizar nubes
            for (let i = clouds.length - 1; i >= 0; i--) {
                clouds[i].x -= clouds[i].speed;
                if (clouds[i].x + clouds[i].width < 0) {
                    clouds.splice(i, 1);
                }
            }

            // Actualizar part√≠culas
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].x += particles[i].velocityX;
                particles[i].y += particles[i].velocityY;
                particles[i].life--;
                
                if (particles[i].life <= 0) {
                    particles.splice(i, 1);
                }
            }

            // Incrementar nivel y dificultad
            const newLevel = Math.floor(gameState.score / 100) + 1;
            if (newLevel > gameState.level) {
                gameState.level = newLevel;
                gameState.speed = Math.min(3 + (gameState.level * 0.5), 8);
            }

            updateHUD();
        }

        // Dibujar todo
        function draw() {
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Fondo degradado
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(0.7, '#98FB98');
            gradient.addColorStop(1, '#228B22');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Dibujar nubes
            clouds.forEach(drawCloud);

            // Dibujar suelo
            drawGround();

            // Dibujar obst√°culos
            obstacles.forEach(drawObstacle);

            // Dibujar jugador
            drawPlayer();

            // Dibujar part√≠culas
            particles.forEach(drawParticle);

            // Mensaje de inicio
            if (!gameState.running && obstacles.length === 0) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = 'white';
                ctx.font = '36px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('RunnerJS', canvas.width/2, 150);
                
                ctx.font = '18px Arial';
                ctx.fillText('Presiona ESPACIO para comenzar', canvas.width/2, 200);
                ctx.fillText('¬°Esquiva los obst√°culos y consigue la mayor puntuaci√≥n!', canvas.width/2, 230);
            }
        }

        // Game Over
        function gameOver() {
            gameState.running = false;
            
            // Crear part√≠culas de explosi√≥n
            for (let i = 0; i < 15; i++) {
                particles.push(createParticle(
                    player.x + player.width/2,
                    player.y + player.height/2
                ));
            }

            // Verificar nuevo r√©cord
            const isNewRecord = gameState.score > gameState.highScore;
            if (isNewRecord) {
                gameState.highScore = gameState.score;
                localStorage.setItem('runnerHighScore', gameState.highScore);
                document.getElementById('newRecord').style.display = 'block';
            } else {
                document.getElementById('newRecord').style.display = 'none';
            }

            // Mostrar modal
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalLevel').textContent = gameState.level;
            document.getElementById('gameOverModal').style.display = 'flex';
            
            updateHUD();
        }

        // Reiniciar juego
        function restartGame() {
            gameState.running = true;
            gameState.score = 0;
            gameState.level = 1;
            gameState.speed = 3;
            
            player.x = 100;
            player.y = 300;
            player.velocityY = 0;
            player.jumping = false;
            player.grounded = true;
            
            obstacles = [];
            particles = [];
            obstacleTimer = 0;
            
            document.getElementById('gameOverModal').style.display = 'none';
            updateHUD();
        }

        // Inicializar juego
        function initGame() {
            gameState.running = false;
            updateHUD();
            loadLeaderboard();
            gameLoop();
        }

        // Loop principal del juego
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // API para puntuaciones
        async function saveScore() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Por favor, ingresa tu nombre');
                return;
            }

            const scoreData = {
                name: playerName,
                score: gameState.score,
                level: gameState.level,
                date: new Date().toISOString()
            };

            try {
                // Intentar guardar en el servidor
                const response = await fetch('/api/scores', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scoreData)
                });

                if (response.ok) {
                    console.log('Puntuaci√≥n guardada en el servidor');
                    loadLeaderboard();
                } else {
                    throw new Error('Servidor no disponible');
                }
            } catch (error) {
                console.log('Guardando en localStorage:', error.message);
                // Fallback a localStorage
                saveToLocalStorage(scoreData);
            }

            document.getElementById('playerName').value = '';
            document.getElementById('gameOverModal').style.display = 'none';
        }

        // Guardar en localStorage como fallback
        function saveToLocalStorage(scoreData) {
            let scores = JSON.parse(localStorage.getItem('runnerScores')) || [];
            scores.push(scoreData);
            scores.sort((a, b) => b.score - a.score);
            scores = scores.slice(0, 10); // Mantener solo top 10
            localStorage.setItem('runnerScores', JSON.stringify(scores));
            loadLeaderboard();
        }

        // Cargar leaderboard
        async function loadLeaderboard() {
            try {
                // Intentar cargar desde el servidor
                const response = await fetch('/api/scores');
                if (response.ok) {
                    const scores = await response.json();
                    displayLeaderboard(scores);
                    return;
                }
            } catch (error) {
                console.log('Cargando desde localStorage');
            }

            // Fallback a localStorage
            const localScores = JSON.parse(localStorage.getItem('runnerScores')) || [];
            displayLeaderboard(localScores);
        }

        // Mostrar leaderboard
        function displayLeaderboard(scores) {
            const leaderboardList = document.getElementById('leaderboardList');
            
            if (scores.length === 0) {
                leaderboardList.innerHTML = `
                    <li class="leaderboard-item">
                        <div class="player-info">
                            <span class="rank">-</span>
                            <span>No hay puntuaciones a√∫n</span>
                        </div>
                        <span>¬°S√© el primero!</span>
                    </li>
                `;
                return;
            }

            leaderboardList.innerHTML = '';
            
            scores.slice(0, 10).forEach((score, index) => {
                const li = document.createElement('li');
                li.className = 'leaderboard-item';
                
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                
                li.innerHTML = `
                    <div class="player-info">
                        <span class="rank ${rankClass}">${index + 1}</span>
                        <span>${score.name}</span>
                    </div>
                    <span>Nivel ${score.level} - ${score.score} pts</span>
                `;
                
                leaderboardList.appendChild(li);
            });
        }

        // Event Listeners
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') {
                e.preventDefault();
                if (gameState.running) {
                    jump();
                } else {
                    restartGame();
                }
            } else if (e.code === 'KeyR') {
                if (!gameState.running && obstacles.length > 0) {
                    restartGame();
                }
            } else if (e.code === 'Enter') {
                if (document.getElementById('gameOverModal').style.display === 'flex') {
                    saveScore();
                }
            }
        });

        // Click en canvas para saltar
        canvas.addEventListener('click', () => {
            if (gameState.running) {
                jump();
            } else {
                restartGame();
            }
        });

        // Touch para m√≥viles
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState.running) {
                jump();
            } else {
                restartGame();
            }
        });

        // Redimensionar canvas para m√≥viles
        function resizeCanvas() {
            const container = document.querySelector('.game-container');
            const containerWidth = container.offsetWidth;
            
            if (window.innerWidth < 768) {
                canvas.style.width = '95vw';
                canvas.style.height = 'auto';
            } else {
                canvas.style.width = '800px';
                canvas.style.height = '400px';
            }
        }

        window.addEventListener('resize', resizeCanvas);

        // Inicializar
        window.addEventListener('load', () => {
            resizeCanvas();
            initGame();
        });
    </script>
</body>
</html>